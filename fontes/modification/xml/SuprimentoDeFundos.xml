<?xml version="1.0" encoding="ISO-8859-1"?>
<modification>
  <name>SuprimentoDeFundos</name>
  <id>SuprimentoDeFundos</id>
  <ecidade-version>2.3.39</ecidade-version>
  
  <file path='classes/empenho.php'>

    <operation>
      <search regex="true"><![CDATA[(\"e50_codord"\s*=>\s*.*\$objNotas.*,)]]></search>
      <add>
        <![CDATA[$1
                "credor"      => $objNotas->credor,]]>
      </add>
    </operation>    

    <operation>
      <search regex="true"><![CDATA[(\$strJson\s*\[\"numnotas\"\]\s*=\s*\"0\"\s*;)]]></search>
      <add>
        <![CDATA[$1

      $sSqlCredor  = "select coalesce(z01_numcgm, 0) as credor";
      $sSqlCredor .= " from empempenho";
      $sSqlCredor .= "  left join empempaut   on  e61_numemp = e60_numemp";
      $sSqlCredor .= "  left join empautoriza on  e54_autori = e61_autori";
      $sSqlCredor .= "  left join plugins.empauttomador on autorizacaoempenho = e54_autori";
      $sSqlCredor .= "  left join plugins.tomadorsuprimento on tomadorsuprimento.sequencial = empauttomador.tomadorsuprimento";
      $sSqlCredor .= "  left join cgm on z01_numcgm = numcgm";
      $sSqlCredor .= " where e60_numemp = {$this->dadosEmpenho->e60_numemp}";
      $rsCredor    = db_query($sSqlCredor);
      $oCredor     = db_utils::fieldsMemory($rsCredor, 0);
      $strJson["credor"] = $oCredor->credor;
      ]]>
      </add>
    </operation>

  </file>

  <file path='forms/db_frmliquidasemordem.php'>

    <operation>
      <search regex="true"><![CDATA[(\$\('e49_numcgm'\)\s*.value\s*=\s*'';)]]></search>
      <add>
        <![CDATA[
    if (obj.credor != 0) {
      $('e49_numcgm').value    = obj.credor;
      $('e49_numcgm').readOnly = true;
      js_pesquisae49_numcgm(false);
    } else if (obj.credor == 0 || obj.credor == null) {
      $1
    }]]>
      </add>
    </operation>    

  </file>

  <file path='emp1_empautoriza005.php'>

    <operation>
      <search regex="true"><![CDATA[(\$erro_msg\s*=\s*\$oDaoEmpenhoProcessoAdminitrativo.*\s*\n*\}.*\s*\n*\}.*\s*\n*\})]]></search>
      <add>
        <![CDATA[$1

  if (!$sqlerro) {
    
    $oDaoEmpAutTomador   = db_utils::getDao("empauttomador");
    $sWhereEmpAutTomador = " autorizacaoempenho = {$e54_autori}";
    $sSqlEmpAutTomador   = $oDaoEmpAutTomador->sql_query_file(null,
                                                                "sequencial",
                                                                null,
                                                                $sWhereEmpAutTomador);
    $rsEmpAutTomador     = $oDaoEmpAutTomador->sql_record($sSqlEmpAutTomador);
    if ($oDaoEmpAutTomador->numrows > 0) {
      $sequencial = db_utils::fieldsMemory($rsEmpAutTomador, 0)->sequencial;
    }
    if (!empty($tomadorsuprimento)) {
    
      $oDaoAlteraEmpAutTomador  = db_utils::getDao("empauttomador");
      $oDaoAlteraEmpAutTomador->sequencial         = $sequencial;
      $oDaoAlteraEmpAutTomador->autorizacaoempenho = $e54_autori;
      $oDaoAlteraEmpAutTomador->tomadorsuprimento  = $tomadorsuprimento;
      $oDaoAlteraEmpAutTomador->alterar($sequencial);

      if ($oDaoAlteraEmpAutTomador->erro_status == 0) {
    
        $sqlerro  = true;
        $erro_msg = $oDaoAlteraEmpAutTomador->erro_msg;
      }
    }
  }]]>
      </add>
    </operation>    

    <operation>
      <search regex="true"><![CDATA[(\$e44_tipo\s*=\s*\$e58_tipo;.*\s*\n*\})]]></search>
      <add>
        <![CDATA[$1
  if ($e44_tipo == 4) {
    $oDaoEmpAutTomador   = db_utils::getDao("empauttomador");
    $sWhereEmpAutTomador = " autorizacaoempenho = {$e54_autori}";
    $sSqlEmpAutTomador   = $oDaoEmpAutTomador->sql_query_file(null,
                                                                "sequencial",
                                                                null,
                                                                $sWhereEmpAutTomador);
    $rsEmpAutTomador     = $oDaoEmpAutTomador->sql_record($sSqlEmpAutTomador);
    if ($oDaoEmpAutTomador->numrows > 0) {
      $tomadorsuprimento = db_utils::fieldsMemory($rsEmpAutTomador, 0)->tomadorsuprimento;
    }
  }]]>
      </add>
    </operation>

  </file>


  <file path='emp1_empautoriza004.php'>

    <operation>
      <search regex="true"><![CDATA[(if\s*\(\$clempautpresta->erro_status==0\)\s*\n*\{\s*\n*\$sqlerro=true;\s*\n*\}\s*\n*\}\s*\n*\})(.*\s*\n*)(\/\*\*\s*\n*\*\s*Inclui.*empautorizaprocesso)]]></search>
      <add>
        <![CDATA[$1
  
  if (!$sqlerro && $e44_tipo == 4 && isset($tomadorsuprimento)) {
    
    $oDaoEmpAutTomador = db_utils::getDao("empauttomador");
    $oDaoEmpAutTomador->sequencial = null;
    $oDaoEmpAutTomador->autorizacaoempenho = $e54_autori;
    $oDaoEmpAutTomador->tomadorsuprimento  = $tomadorsuprimento;
    $oDaoEmpAutTomador->incluir(null);
    
    if ($oDaoEmpAutTomador->erro_status == 0) {
        $sqlerro  = true;
        $erro_msg = $oDaoEmpAutTomador->erro_msg;
    }
  }

  $3]]>
      </add>
    </operation>

  </file>
</modification>
